<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dots and Boxes - لعبة النقاط والصناديق</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="data:application/json,{
        'name': 'لعبة النقاط والصناديق',
        'short_name': 'النقاط والصناديق',
        'description': 'لعبة النقاط والصناديق التفاعلية',
        'start_url': '/',
        'display': 'standalone',
        'background_color': '#ffffff',
        'theme_color': '#667eea',
        'orientation': 'any',
        'icons': [
            {
                'src': 'https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9',
                'sizes': '1024x1024',
                'type': 'image/png',
                'purpose': 'any maskable'
            }
        ]
    }">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    <link rel="apple-touch-icon" sizes="152x152" href="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    
    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" href="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    <meta name="msapplication-TileColor" content="#667eea">
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: #ffffff;
            color: #333333;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
        }

        .dark-mode .bg-white {
            background-color: #2d3748 !important;
        }

        .dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }

        .dark-mode .text-gray-600 {
            color: #a0aec0 !important;
        }

        .dark-mode .border-gray-300 {
            border-color: #4a5568 !important;
        }

        .game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .dark-mode .game-title {
            background: linear-gradient(45deg, #81c784, #4fc3f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #666666;
            font-size: 1.1rem;
        }

        .dark-mode .subtitle {
            color: rgba(255, 255, 255, 0.8);
        }

        .game-board {
            position: relative;
            background: #f8f9fa;
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
        }

        .dark-mode .game-board {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dot {
            width: 16px;
            height: 16px;
            background: #495057;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .dark-mode .dot {
            background: #81c784;
        }

        .dot:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 16px rgba(73, 80, 87, 0.4);
        }

        .line {
            position: absolute;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 3px;
            z-index: 5;
        }

        .line.horizontal {
            height: 6px;
            transform: translateY(-3px);
        }

        .line.vertical {
            width: 6px;
            transform: translateX(-3px);
        }

        /* Player 1 lines - Blue */
        .line.player1 {
            background: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .line.player1:hover {
            background: #0056b3;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.5);
        }

        /* Player 2 lines - Red */
        .line.player2 {
            background: #dc3545;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .line.player2:hover {
            background: #c82333;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5);
        }

        /* Available lines - Gray */
        .line.available {
            background: #ced4da;
            opacity: 0.7;
        }

        .line.available:hover {
            background: #adb5bd;
            opacity: 1;
            transform: scale(1.1);
        }

        .dark-mode .line.available {
            background: #6c757d;
        }

        .dark-mode .line.available:hover {
            background: #5a6268;
        }

        .line.drawn {
            cursor: default;
        }

        .box {
            position: absolute;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 28px;
            transition: all 0.3s ease;
            transform: scale(0);
            border: 3px solid transparent;
        }

        .box.filled {
            transform: scale(1);
            animation: boxFill 0.5s ease-out;
        }

        @keyframes boxFill {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(90deg); opacity: 0.8; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .player1-box {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            border-color: #0056b3;
        }

        .player2-box {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            border-color: #c82333;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Tajawal', sans-serif;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            color: #333;
        }

        .score-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .score-card {
            background: #ffffff;
            border: 2px solid #e9ecef;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .score-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .score-card.active {
            transform: scale(1.02);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .score-card.player1.active {
            border-color: #007bff;
            box-shadow: 0 8px 32px rgba(0, 123, 255, 0.3);
        }

        .score-card.player2.active {
            border-color: #dc3545;
            box-shadow: 0 8px 32px rgba(220, 53, 69, 0.3);
        }

        .score-title {
            color: #495057;
            margin-bottom: 10px;
        }

        .dark-mode .score-title {
            color: #e2e8f0;
        }

        .score-value {
            color: #333333;
            font-size: 2.5rem;
        }

        .dark-mode .score-value {
            color: #ffffff;
        }

        .game-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            color: #495057;
        }

        .dark-mode .game-info {
            color: rgba(255, 255, 255, 0.9);
        }

        .winner-announcement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: winnerPop 0.5s ease-out;
        }

        @keyframes winnerPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1) rotate(0deg); opacity: 0.9; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }

        .settings-panel {
            background: #ffffff;
            border: 2px solid #e9ecef;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .settings-panel {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-title {
            color: #333333;
            margin-bottom: 20px;
        }

        .dark-mode .settings-title {
            color: #ffffff;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-label {
            font-weight: 500;
            color: #495057;
        }

        .dark-mode .setting-label {
            color: rgba(255, 255, 255, 0.8);
        }

        select, input {
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            background: #ffffff;
            color: #495057;
            font-family: 'Tajawal', sans-serif;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .dark-mode select, .dark-mode input {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .dark-mode .theme-toggle {
            background: linear-gradient(135deg, #81c784, #4fc3f7);
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .game-board {
                padding: 25px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .score-board {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        .dark-mode .loading {
            border-color: rgba(255, 255, 255, 0.3);
            border-top-color: white;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <div class="game-container">
        <!-- Logo and Title -->
        <div class="logo-container">
            <img src="https://cdn1.genspark.ai/user-upload-image/22_generated/3284c03f-0b88-499e-9d93-4443dface24e" alt="Dots and Boxes Logo" class="logo">
            <h1 class="game-title">لعبة النقاط والصناديق</h1>
            <p class="subtitle">Dots and Boxes Game</p>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <h3 class="text-xl font-bold text-center settings-title">
                <i class="fas fa-cog"></i> إعدادات اللعبة
            </h3>
            <div class="settings-grid">
                <div class="setting-group">
                    <label class="setting-label">حجم الشبكة</label>
                    <select id="gridSize">
                        <option value="3">3×3</option>
                        <option value="4">4×4</option>
                        <option value="5">5×5</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">وضع اللعب</label>
                    <select id="gameMode">
                        <option value="two-player">لاعبان محليان</option>
                        <option value="ai">ضد الذكاء الاصطناعي</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">مستوى الذكاء الاصطناعي</label>
                    <select id="aiDifficulty">
                        <option value="easy">سهل</option>
                        <option value="medium">متوسط</option>
                        <option value="hard">صعب</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">الأصوات</label>
                    <select id="soundEnabled">
                        <option value="true">مفعل</option>
                        <option value="false">معطل</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Score Board -->
        <div class="score-board">
            <div class="score-card player1" id="player1Card">
                <h3 class="text-lg font-bold mb-2 score-title">
                    <i class="fas fa-user" style="color: #007bff;"></i> اللاعب الأول
                </h3>
                <div class="score-value" id="player1Score">0</div>
                <div class="text-sm opacity-75">نقطة</div>
            </div>
            <div class="score-card player2" id="player2Card">
                <h3 class="text-lg font-bold mb-2 score-title">
                    <i class="fas fa-robot" style="color: #dc3545;"></i> اللاعب الثاني
                </h3>
                <div class="score-value" id="player2Score">0</div>
                <div class="text-sm opacity-75">نقطة</div>
            </div>
        </div>

        <!-- Game Info -->
        <div class="game-info">
            <p class="font-medium">
                <span id="currentPlayerText">دور اللاعب الأول</span>
                <span id="aiThinking" class="hidden">
                    <span class="loading"></span> الذكاء الاصطناعي يفكر...
                </span>
            </p>
        </div>

        <!-- Game Board -->
        <div class="game-board">
            <div id="gameGrid" style="position: relative; margin: 0 auto;"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" onclick="startNewGame()">
                <i class="fas fa-play"></i> لعبة جديدة
            </button>
            <button class="btn btn-secondary" onclick="restartGame()">
                <i class="fas fa-redo"></i> إعادة تشغيل
            </button>
            <button class="btn btn-success" onclick="toggleSound()">
                <i class="fas fa-volume-up" id="soundIcon"></i> 
                <span id="soundText">الصوت مفعل</span>
            </button>
            <button class="btn btn-warning" onclick="showInstructions()">
                <i class="fas fa-question-circle"></i> التعليمات
            </button>
        </div>
    </div>

    <!-- Winner Announcement (Hidden initially) -->
    <div id="winnerAnnouncement" class="winner-announcement" style="display: none;">
        <h2 class="text-3xl font-bold mb-4">
            <i class="fas fa-trophy"></i> مبروك!
        </h2>
        <p class="text-xl mb-4" id="winnerText"></p>
        <button class="btn btn-primary" onclick="hideWinnerAnnouncement()">
            <i class="fas fa-play"></i> لعبة جديدة
        </button>
    </div>

    <script>
        class DotsAndBoxesGame {
            constructor() {
                this.gridSize = 3;
                this.gameMode = 'two-player';
                this.aiDifficulty = 'medium';
                this.soundEnabled = true;
                this.currentPlayer = 1;
                this.scores = [0, 0];
                this.gameBoard = null;
                this.dots = [];
                this.lines = [];
                this.boxes = [];
                this.gameActive = false;
                this.isThinking = false;
                
                this.initializeGame();
                this.setupEventListeners();
                this.loadSettings();
            }

            initializeGame() {
                this.createGameBoard();
                this.updateDisplay();
                this.gameActive = true;
            }

            setupEventListeners() {
                document.getElementById('gridSize').addEventListener('change', (e) => {
                    this.gridSize = parseInt(e.target.value);
                    this.saveSettings();
                    this.startNewGame();
                });

                document.getElementById('gameMode').addEventListener('change', (e) => {
                    this.gameMode = e.target.value;
                    this.updatePlayerLabels();
                    this.saveSettings();
                });

                document.getElementById('aiDifficulty').addEventListener('change', (e) => {
                    this.aiDifficulty = e.target.value;
                    this.saveSettings();
                });

                document.getElementById('soundEnabled').addEventListener('change', (e) => {
                    this.soundEnabled = e.target.value === 'true';
                    this.saveSettings();
                    this.updateSoundButton();
                });
            }

            createGameBoard() {
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';
                
                // Increased cell size for bigger boxes
                const cellSize = Math.min(500, window.innerWidth - 100) / this.gridSize;
                const boardSize = cellSize * (this.gridSize - 1);
                
                gameGrid.style.width = boardSize + 'px';
                gameGrid.style.height = boardSize + 'px';

                this.dots = [];
                this.lines = [];
                this.boxes = [];

                // Create dots
                for (let row = 0; row < this.gridSize; row++) {
                    for (let col = 0; col < this.gridSize; col++) {
                        const dot = document.createElement('div');
                        dot.className = 'dot';
                        dot.style.left = (col * cellSize - 8) + 'px';
                        dot.style.top = (row * cellSize - 8) + 'px';
                        gameGrid.appendChild(dot);
                        this.dots.push({ element: dot, row, col });
                    }
                }

                // Create horizontal lines
                for (let row = 0; row < this.gridSize; row++) {
                    for (let col = 0; col < this.gridSize - 1; col++) {
                        const line = document.createElement('div');
                        line.className = 'line horizontal available';
                        line.style.left = (col * cellSize + 8) + 'px';
                        line.style.top = (row * cellSize - 3) + 'px';
                        line.style.width = (cellSize - 16) + 'px';
                        line.dataset.direction = 'horizontal';
                        line.dataset.row = row;
                        line.dataset.col = col;
                        line.addEventListener('click', () => this.handleLineClick(line));
                        gameGrid.appendChild(line);
                        this.lines.push({ element: line, row, col, direction: 'horizontal', drawn: false, player: null });
                    }
                }

                // Create vertical lines
                for (let row = 0; row < this.gridSize - 1; row++) {
                    for (let col = 0; col < this.gridSize; col++) {
                        const line = document.createElement('div');
                        line.className = 'line vertical available';
                        line.style.left = (col * cellSize - 3) + 'px';
                        line.style.top = (row * cellSize + 8) + 'px';
                        line.style.height = (cellSize - 16) + 'px';
                        line.dataset.direction = 'vertical';
                        line.dataset.row = row;
                        line.dataset.col = col;
                        line.addEventListener('click', () => this.handleLineClick(line));
                        gameGrid.appendChild(line);
                        this.lines.push({ element: line, row, col, direction: 'vertical', drawn: false, player: null });
                    }
                }

                // Create boxes
                for (let row = 0; row < this.gridSize - 1; row++) {
                    for (let col = 0; col < this.gridSize - 1; col++) {
                        const box = document.createElement('div');
                        box.className = 'box';
                        box.style.left = (col * cellSize + 8) + 'px';
                        box.style.top = (row * cellSize + 8) + 'px';
                        box.style.width = (cellSize - 16) + 'px';
                        box.style.height = (cellSize - 16) + 'px';
                        gameGrid.appendChild(box);
                        this.boxes.push({ element: box, row, col, filled: false, owner: null });
                    }
                }
            }

            handleLineClick(lineElement) {
                if (!this.gameActive || this.isThinking) return;

                const row = parseInt(lineElement.dataset.row);
                const col = parseInt(lineElement.dataset.col);
                const direction = lineElement.dataset.direction;

                const line = this.lines.find(l => 
                    l.row === row && l.col === col && l.direction === direction
                );

                if (line && !line.drawn) {
                    this.drawLine(line);
                }
            }

            drawLine(line) {
                line.drawn = true;
                line.player = this.currentPlayer;
                line.element.classList.remove('available');
                line.element.classList.add('drawn', `player${this.currentPlayer}`);
                
                this.playSound('line');
                
                const completedBoxes = this.checkCompletedBoxes(line);
                
                if (completedBoxes.length > 0) {
                    completedBoxes.forEach(box => {
                        this.fillBox(box, this.currentPlayer);
                    });
                    this.scores[this.currentPlayer - 1] += completedBoxes.length;
                    this.playSound('box');
                } else {
                    this.switchPlayer();
                }

                this.updateDisplay();

                if (this.isGameComplete()) {
                    this.endGame();
                } else if (this.gameMode === 'ai' && this.currentPlayer === 2 && !this.isThinking) {
                    this.makeAIMove();
                }
            }

            checkCompletedBoxes(drawnLine) {
                const completedBoxes = [];
                
                this.boxes.forEach(box => {
                    if (!box.filled && this.isBoxComplete(box)) {
                        completedBoxes.push(box);
                    }
                });

                return completedBoxes;
            }

            isBoxComplete(box) {
                const { row, col } = box;
                
                // Check all four sides of the box
                const topLine = this.lines.find(l => 
                    l.row === row && l.col === col && l.direction === 'horizontal'
                );
                const bottomLine = this.lines.find(l => 
                    l.row === row + 1 && l.col === col && l.direction === 'horizontal'
                );
                const leftLine = this.lines.find(l => 
                    l.row === row && l.col === col && l.direction === 'vertical'
                );
                const rightLine = this.lines.find(l => 
                    l.row === row && l.col === col + 1 && l.direction === 'vertical'
                );

                return topLine?.drawn && bottomLine?.drawn && leftLine?.drawn && rightLine?.drawn;
            }

            fillBox(box, player) {
                box.filled = true;
                box.owner = player;
                box.element.classList.add('filled', `player${player}-box`);
                box.element.textContent = player === 1 ? 'P1' : (this.gameMode === 'ai' ? 'AI' : 'P2');
            }

            switchPlayer() {
                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
            }

            makeAIMove() {
                if (this.isThinking) return;
                
                this.isThinking = true;
                this.updateDisplay();

                setTimeout(() => {
                    const availableLines = this.lines.filter(line => !line.drawn);
                    if (availableLines.length === 0) {
                        this.isThinking = false;
                        return;
                    }

                    let selectedLine;

                    switch (this.aiDifficulty) {
                        case 'easy':
                            selectedLine = this.getRandomMove(availableLines);
                            break;
                        case 'medium':
                            selectedLine = this.getMediumMove(availableLines);
                            break;
                        case 'hard':
                            selectedLine = this.getHardMove(availableLines);
                            break;
                    }

                    this.isThinking = false;
                    this.drawLine(selectedLine);
                }, 1000 + Math.random() * 1000); // Random delay for realistic feel
            }

            getRandomMove(availableLines) {
                return availableLines[Math.floor(Math.random() * availableLines.length)];
            }

            getMediumMove(availableLines) {
                // Try to complete a box first
                for (let line of availableLines) {
                    if (this.wouldCompleteBox(line)) {
                        return line;
                    }
                }

                // Avoid giving opponent a box if possible
                const safeLines = availableLines.filter(line => !this.wouldGiveOpponentBox(line));
                if (safeLines.length > 0) {
                    return safeLines[Math.floor(Math.random() * safeLines.length)];
                }

                return this.getRandomMove(availableLines);
            }

            getHardMove(availableLines) {
                // Prioritize completing boxes
                const completingLines = availableLines.filter(line => this.wouldCompleteBox(line));
                if (completingLines.length > 0) {
                    return completingLines[0];
                }

                // Avoid giving opponent multiple boxes
                const safeLines = availableLines.filter(line => !this.wouldGiveOpponentBox(line));
                if (safeLines.length > 0) {
                    // Choose strategically positioned lines
                    const strategicLines = safeLines.filter(line => this.isStrategicPosition(line));
                    if (strategicLines.length > 0) {
                        return strategicLines[0];
                    }
                    return safeLines[0];
                }

                // If we must give opponent a box, choose the one that gives the least advantage
                return availableLines[0];
            }

            wouldCompleteBox(line) {
                // Temporarily draw the line and check for completed boxes
                line.drawn = true;
                const completedBoxes = this.checkCompletedBoxes(line);
                line.drawn = false;
                return completedBoxes.length > 0;
            }

            wouldGiveOpponentBox(line) {
                // Check if drawing this line would allow opponent to complete box on next turn
                line.drawn = true;
                const availableAfter = this.lines.filter(l => !l.drawn);
                let wouldGive = false;

                for (let otherLine of availableAfter) {
                    if (this.wouldCompleteBox(otherLine)) {
                        wouldGive = true;
                        break;
                    }
                }

                line.drawn = false;
                return wouldGive;
            }

            isStrategicPosition(line) {
                // Prefer center and edge positions over corners in early game
                const totalLines = (this.gridSize - 1) * this.gridSize * 2;
                const drawnLines = this.lines.filter(l => l.drawn).length;
                
                if (drawnLines < totalLines * 0.3) {
                    // Early game: prefer center positions
                    const centerRow = Math.floor(this.gridSize / 2);
                    const centerCol = Math.floor(this.gridSize / 2);
                    return Math.abs(line.row - centerRow) <= 1 && Math.abs(line.col - centerCol) <= 1;
                }
                
                return true;
            }

            isGameComplete() {
                return this.boxes.every(box => box.filled);
            }

            endGame() {
                this.gameActive = false;
                const winner = this.scores[0] > this.scores[1] ? 1 : 
                              this.scores[1] > this.scores[0] ? 2 : 0;
                
                this.playSound('win');
                this.showWinner(winner);
            }

            showWinner(winner) {
                const winnerAnnouncement = document.getElementById('winnerAnnouncement');
                const winnerText = document.getElementById('winnerText');
                
                if (winner === 0) {
                    winnerText.textContent = 'تعادل! أحسنتما اللعب!';
                } else if (winner === 1) {
                    winnerText.textContent = 'اللاعب الأول فاز!';
                } else {
                    winnerText.textContent = this.gameMode === 'ai' ? 'الذكاء الاصطناعي فاز!' : 'اللاعب الثاني فاز!';
                }
                
                winnerAnnouncement.style.display = 'block';
            }

            updateDisplay() {
                // Update scores
                document.getElementById('player1Score').textContent = this.scores[0];
                document.getElementById('player2Score').textContent = this.scores[1];

                // Update current player highlight
                const player1Card = document.getElementById('player1Card');
                const player2Card = document.getElementById('player2Card');
                
                player1Card.classList.toggle('active', this.currentPlayer === 1);
                player2Card.classList.toggle('active', this.currentPlayer === 2);

                // Update current player text
                const currentPlayerText = document.getElementById('currentPlayerText');
                const aiThinking = document.getElementById('aiThinking');

                if (this.isThinking) {
                    currentPlayerText.classList.add('hidden');
                    aiThinking.classList.remove('hidden');
                } else {
                    currentPlayerText.classList.remove('hidden');
                    aiThinking.classList.add('hidden');
                    
                    if (this.currentPlayer === 1) {
                        currentPlayerText.textContent = 'دور اللاعب الأول';
                    } else {
                        currentPlayerText.textContent = this.gameMode === 'ai' ? 'دور الذكاء الاصطناعي' : 'دور اللاعب الثاني';
                    }
                }
            }

            updatePlayerLabels() {
                const player2Label = document.querySelector('#player2Card .score-title');
                if (this.gameMode === 'ai') {
                    player2Label.innerHTML = '<i class="fas fa-robot" style="color: #dc3545;"></i> الذكاء الاصطناعي';
                } else {
                    player2Label.innerHTML = '<i class="fas fa-user" style="color: #dc3545;"></i> اللاعب الثاني';
                }
            }

            playSound(type) {
                if (!this.soundEnabled) return;

                // Create audio context for sound generation
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    switch (type) {
                        case 'line':
                            oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                            oscillator.start();
                            oscillator.stop(audioContext.currentTime + 0.1);
                            break;
                        case 'box':
                            oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                            oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.1);
                            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                            oscillator.start();
                            oscillator.stop(audioContext.currentTime + 0.3);
                            break;
                        case 'win':
                            // Play a victory melody
                            [523, 659, 784, 1047].forEach((freq, i) => {
                                const osc = audioContext.createOscillator();
                                const gain = audioContext.createGain();
                                osc.connect(gain);
                                gain.connect(audioContext.destination);
                                osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.2);
                                gain.gain.setValueAtTime(0.1, audioContext.currentTime + i * 0.2);
                                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.2 + 0.2);
                                osc.start(audioContext.currentTime + i * 0.2);
                                osc.stop(audioContext.currentTime + i * 0.2 + 0.2);
                            });
                            break;
                    }
                } catch (error) {
                    console.log('Audio not supported');
                }
            }

            startNewGame() {
                this.currentPlayer = 1;
                this.scores = [0, 0];
                this.gameActive = false;
                this.isThinking = false;
                this.initializeGame();
            }

            restartGame() {
                this.startNewGame();
            }

            saveSettings() {
                const settings = {
                    gridSize: this.gridSize,
                    gameMode: this.gameMode,
                    aiDifficulty: this.aiDifficulty,
                    soundEnabled: this.soundEnabled
                };
                localStorage.setItem('dotsAndBoxesSettings', JSON.stringify(settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('dotsAndBoxesSettings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    this.gridSize = settings.gridSize || 3;
                    this.gameMode = settings.gameMode || 'two-player';
                    this.aiDifficulty = settings.aiDifficulty || 'medium';
                    this.soundEnabled = settings.soundEnabled !== false;

                    // Update UI
                    document.getElementById('gridSize').value = this.gridSize;
                    document.getElementById('gameMode').value = this.gameMode;
                    document.getElementById('aiDifficulty').value = this.aiDifficulty;
                    document.getElementById('soundEnabled').value = this.soundEnabled.toString();
                }
                this.updatePlayerLabels();
                this.updateSoundButton();
            }

            updateSoundButton() {
                const soundIcon = document.getElementById('soundIcon');
                const soundText = document.getElementById('soundText');
                
                if (this.soundEnabled) {
                    soundIcon.className = 'fas fa-volume-up';
                    soundText.textContent = 'الصوت مفعل';
                } else {
                    soundIcon.className = 'fas fa-volume-mute';
                    soundText.textContent = 'الصوت معطل';
                }
            }
        }

        // Global game instance
        let game;

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            game = new DotsAndBoxesGame();
        });

        // Global functions for button handlers
        function startNewGame() {
            game.startNewGame();
        }

        function restartGame() {
            game.restartGame();
        }

        function toggleSound() {
            game.soundEnabled = !game.soundEnabled;
            document.getElementById('soundEnabled').value = game.soundEnabled.toString();
            game.updateSoundButton();
            game.saveSettings();
        }

        function hideWinnerAnnouncement() {
            document.getElementById('winnerAnnouncement').style.display = 'none';
            game.startNewGame();
        }

        function showInstructions() {
            alert(`تعليمات لعبة النقاط والصناديق:

1. اختر حجم الشبكة ووضع اللعب من الإعدادات
2. اضغط على الخطوط بين النقاط لرسمها
3. عندما تكمل مربعاً، ستحصل على نقطة وفرصة إضافية
4. الهدف هو الحصول على أكبر عدد من المربعات
5. اللاعب الذي يحصل على أكثر مربعات يفوز

ملاحظة: اللاعب الأول يلعب بالخطوط الزرقاء واللاعب الثاني بالخطوط الحمراء

استمتع باللعب!`);
        }

        // Theme toggle functionality
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            const themeIcon = document.getElementById('theme-icon');
            
            if (isDark) {
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('darkMode', 'true');
            } else {
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('darkMode', 'false');
            }
        }

        // Load theme preference
        document.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').className = 'fas fa-sun';
            }
        });

        // PWA Installation
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button or banner
            const installBanner = document.createElement('div');
            installBanner.innerHTML = `
                <div style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000;">
                    <p style="margin: 0 0 10px 0;">أضف اللعبة للشاشة الرئيسية</p>
                    <button onclick="installPWA()" style="background: white; color: #667eea; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">تثبيت</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">إلغاء</button>
                </div>
            `;
            document.body.appendChild(installBanner);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,const CACHE_NAME="dots-boxes-v1";const urlsToCache=["/"];self.addEventListener("install",event=>{event.waitUntil(caches.open(CACHE_NAME).then(cache=>cache.addAll(urlsToCache)))});self.addEventListener("fetch",event=>{event.respondWith(caches.match(event.request).then(response=>{if(response){return response}return fetch(event.request)}))});')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }
    </script>
</body>
</html>