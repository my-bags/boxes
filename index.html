<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dots and Boxes - لعبة النقاط والصناديق</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="data:application/json,{
        'name': 'لعبة النقاط والصناديق',
        'short_name': 'النقاط والصناديق',
        'description': 'لعبة النقاط والصناديق التفاعلية',
        'start_url': '/',
        'display': 'standalone',
        'background_color': '#ffffff',
        'theme_color': '#667eea',
        'orientation': 'any',
        'icons': [
            {
                'src': 'https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9',
                'sizes': '1024x1024',
                'type': 'image/png',
                'purpose': 'any maskable'
            }
        ]
    }">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    <link rel="apple-touch-icon" sizes="152x152" href="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    
    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" href="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="https://cdn1.genspark.ai/user-upload-image/22_generated/61a6d3d1-4a3e-4828-8be2-2bbbd3f47cd9">
    <meta name="msapplication-TileColor" content="#667eea">
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            transition: all 0.3s ease;
            color: #1a202c;
        }

        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
        }

        .dark-mode .bg-white {
            background-color: #2d3748 !important;
        }

        .dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }

        .dark-mode .text-gray-600 {
            color: #a0aec0 !important;
        }

        .dark-mode .border-gray-300 {
            border-color: #4a5568 !important;
        }

        .game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .dark-mode .game-title {
            background: linear-gradient(45deg, #81c784, #4fc3f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .game-board {
            position: relative;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dark-mode .game-board {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dot {
            width: 14px;
            height: 14px;
            background: #4a5568;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .dark-mode .dot {
            background: #e2e8f0;
        }

        .dot:hover {
            transform: scale(1.4);
            box-shadow: 0 4px 16px rgba(74, 85, 104, 0.4);
        }

        .line {
            position: absolute;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 3px;
            z-index: 5;
        }

        .line.horizontal {
            height: 5px;
            transform: translateY(-2.5px);
        }

        .line.vertical {
            width: 5px;
            transform: translateX(-2.5px);
        }

        .line.player1 {
            background: #667eea;
        }

        .line.player2 {
            background: #48bb78;
        }

        .dark-mode .line.player1 {
            background: #81c784;
        }

        .dark-mode .line.player2 {
            background: #4fc3f7;
        }

        .line:not(.drawn) {
            background: rgba(0, 0, 0, 0.1);
        }

        .dark-mode .line:not(.drawn) {
            background: rgba(255, 255, 255, 0.1);
        }

        .line:not(.drawn):hover {
            background: rgba(102, 126, 234, 0.3);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .dark-mode .line:not(.drawn):hover {
            background: rgba(129, 199, 132, 0.3);
            box-shadow: 0 0 10px rgba(129, 199, 132, 0.3);
        }

        .line.drawn {
            cursor: default;
        }

        .box {
            position: absolute;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 28px;
            transition: all 0.3s ease;
            transform: scale(0);
            z-index: 1;
        }

        .box.filled {
            transform: scale(1);
            animation: boxFill 0.5s ease-out;
        }

        @keyframes boxFill {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(90deg); opacity: 0.8; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .player1-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .player2-box {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Tajawal', sans-serif;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            font-size: 16px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .score-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .score-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .dark-mode .score-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .score-card.active {
            transform: scale(1.02);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25);
            border-color: #667eea;
        }

        .dark-mode .score-card.active {
            border-color: #81c784;
            box-shadow: 0 12px 40px rgba(129, 199, 132, 0.25);
        }

        .game-info {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .winner-announcement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: winnerPop 0.6s ease-out;
            max-width: 90vw;
        }

        @keyframes winnerPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1) rotate(0deg); opacity: 0.9; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }

        .settings-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark-mode .settings-panel {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 15px;
        }

        .dark-mode .setting-label {
            color: rgba(255, 255, 255, 0.9);
        }

        select, input {
            padding: 12px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.8);
            color: #2d3748;
            font-family: 'Tajawal', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .dark-mode select, .dark-mode input {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .dark-mode select:focus, .dark-mode input:focus {
            border-color: #81c784;
            box-shadow: 0 0 0 3px rgba(129, 199, 132, 0.1);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            z-index: 100;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }

        .dark-mode .theme-toggle {
            background: linear-gradient(135deg, #81c784, #4fc3f7);
        }

        .audio-status {
            position: fixed;
            top: 90px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .audio-status.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .game-board {
                padding: 25px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .score-board {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .theme-toggle {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="تغيير المظهر">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <!-- Audio Status Indicator -->
    <div class="audio-status" id="audioStatus">
        <i class="fas fa-volume-up"></i> جاهز
    </div>

    <div class="game-container">
        <!-- Logo and Title -->
        <div class="logo-container">
            <img src="https://cdn1.genspark.ai/user-upload-image/22_generated/3284c03f-0b88-499e-9d93-4443dface24e" alt="Dots and Boxes Logo" class="logo">
            <h1 class="game-title">لعبة النقاط والصناديق</h1>
            <p class="text-gray-600 text-lg font-medium">Dots and Boxes Game</p>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <h3 class="text-xl font-bold mb-6 text-center">
                <i class="fas fa-cog"></i> إعدادات اللعبة
            </h3>
            <div class="settings-grid">
                <div class="setting-group">
                    <label class="setting-label">حجم الشبكة</label>
                    <select id="gridSize">
                        <option value="3">3×3 (سريع)</option>
                        <option value="4" selected>4×4 (متوسط)</option>
                        <option value="5">5×5 (طويل)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">وضع اللعب</label>
                    <select id="gameMode">
                        <option value="two-player">لاعبان محليان</option>
                        <option value="ai">ضد الذكاء الاصطناعي</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">مستوى الذكاء الاصطناعي</label>
                    <select id="aiDifficulty">
                        <option value="easy">سهل</option>
                        <option value="medium" selected>متوسط</option>
                        <option value="hard">صعب</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">الأصوات</label>
                    <select id="soundEnabled">
                        <option value="true">مفعل</option>
                        <option value="false">معطل</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Score Board -->
        <div class="score-board">
            <div class="score-card" id="player1Card">
                <h3 class="text-lg font-bold mb-3">
                    <i class="fas fa-user"></i> اللاعب الأول
                </h3>
                <div class="text-4xl font-bold mb-2" id="player1Score">0</div>
                <div class="text-sm opacity-75">مربع</div>
            </div>
            <div class="score-card" id="player2Card">
                <h3 class="text-lg font-bold mb-3">
                    <i class="fas fa-robot"></i> اللاعب الثاني
                </h3>
                <div class="text-4xl font-bold mb-2" id="player2Score">0</div>
                <div class="text-sm opacity-75">مربع</div>
            </div>
        </div>

        <!-- Game Info -->
        <div class="game-info">
            <p class="font-semibold">
                <span id="currentPlayerText">دور اللاعب الأول</span>
                <span id="aiThinking" class="hidden">
                    <span class="loading"></span> الذكاء الاصطناعي يفكر...
                </span>
            </p>
        </div>

        <!-- Game Board -->
        <div class="game-board">
            <div id="gameGrid" style="position: relative; margin: 0 auto;"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" onclick="startNewGame()">
                <i class="fas fa-play"></i> لعبة جديدة
            </button>
            <button class="btn btn-secondary" onclick="restartGame()">
                <i class="fas fa-redo"></i> إعادة تشغيل
            </button>
            <button class="btn btn-success" onclick="toggleSound()" id="soundButton">
                <i class="fas fa-volume-up" id="soundIcon"></i> 
                <span id="soundText">الصوت مفعل</span>
            </button>
            <button class="btn btn-warning" onclick="showInstructions()">
                <i class="fas fa-question-circle"></i> التعليمات
            </button>
        </div>
    </div>

    <!-- Winner Announcement (Hidden initially) -->
    <div id="winnerAnnouncement" class="winner-announcement" style="display: none;">
        <h2 class="text-4xl font-bold mb-6">
            <i class="fas fa-trophy"></i> مبروك!
        </h2>
        <p class="text-2xl mb-6" id="winnerText"></p>
        <button class="btn btn-primary" onclick="hideWinnerAnnouncement()">
            <i class="fas fa-play"></i> لعبة جديدة
        </button>
    </div>

    <script>
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.isInitialized = false;
                this.soundEnabled = true;
                this.sounds = {
                    line: { frequency: 400, duration: 0.1 },
                    box: { frequency: 600, duration: 0.3 },
                    win: { frequencies: [523, 659, 784, 1047], duration: 0.8 }
                };
                this.initAudio();
            }

            async initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.isInitialized = true;
                    this.showAudioStatus('جاهز', 'success');
                } catch (error) {
                    console.warn('Audio not supported:', error);
                    this.showAudioStatus('غير مدعوم', 'error');
                }
            }

            async resumeAudioContext() {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    try {
                        await this.audioContext.resume();
                        this.showAudioStatus('مُفعل', 'success');
                        return true;
                    } catch (error) {
                        console.warn('Could not resume audio context:', error);
                        this.showAudioStatus('خطأ', 'error');
                        return false;
                    }
                }
                return this.audioContext && this.audioContext.state === 'running';
            }

            showAudioStatus(text, type) {
                const status = document.getElementById('audioStatus');
                if (!status) return;

                status.textContent = text;
                status.className = 'audio-status show';
                
                if (type === 'error') {
                    status.style.background = 'rgba(244, 63, 94, 0.9)';
                } else {
                    status.style.background = 'rgba(34, 197, 94, 0.9)';
                }

                setTimeout(() => {
                    status.classList.remove('show');
                }, 2000);
            }

            async playSound(type) {
                if (!this.soundEnabled || !this.isInitialized) return;

                const isResumed = await this.resumeAudioContext();
                if (!isResumed) return;

                try {
                    switch (type) {
                        case 'line':
                            this.playTone(this.sounds.line.frequency, this.sounds.line.duration, 0.1);
                            break;
                        case 'box':
                            this.playComplexTone();
                            break;
                        case 'win':
                            this.playWinMelody();
                            break;
                    }
                } catch (error) {
                    console.warn('Sound play error:', error);
                }
            }

            playTone(frequency, duration, volume = 0.1) {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playComplexTone() {
                const baseTime = this.audioContext.currentTime;
                this.playTone(600, 0.1, 0.15);
                setTimeout(() => this.playTone(800, 0.2, 0.12), 100);
            }

            playWinMelody() {
                const frequencies = [523, 659, 784, 1047];
                frequencies.forEach((freq, i) => {
                    setTimeout(() => {
                        this.playTone(freq, 0.2, 0.1);
                    }, i * 150);
                });
            }

            setSoundEnabled(enabled) {
                this.soundEnabled = enabled;
                if (enabled && !this.isInitialized) {
                    this.initAudio();
                }
            }
        }

        class DotsAndBoxesGame {
            constructor() {
                this.gridSize = 4;
                this.gameMode = 'two-player';
                this.aiDifficulty = 'medium';
                this.currentPlayer = 1;
                this.scores = [0, 0];
                this.gameBoard = null;
                this.dots = [];
                this.lines = [];
                this.boxes = [];
                this.gameActive = false;
                this.isThinking = false;
                
                this.audioManager = new AudioManager();
                
                this.initializeGame();
                this.setupEventListeners();
                this.loadSettings();
                
                // Enable audio on first user interaction
                this.setupAudioUnlock();
            }

            setupAudioUnlock() {
                const unlockAudio = async () => {
                    await this.audioManager.resumeAudioContext();
                    document.removeEventListener('click', unlockAudio);
                    document.removeEventListener('touchstart', unlockAudio);
                };
                
                document.addEventListener('click', unlockAudio);
                document.addEventListener('touchstart', unlockAudio);
            }

            initializeGame() {
                this.createGameBoard();
                this.updateDisplay();
                this.gameActive = true;
            }

            setupEventListeners() {
                document.getElementById('gridSize').addEventListener('change', (e) => {
                    this.gridSize = parseInt(e.target.value);
                    this.saveSettings();
                    this.startNewGame();
                });

                document.getElementById('gameMode').addEventListener('change', (e) => {
                    this.gameMode = e.target.value;
                    this.updatePlayerLabels();
                    this.saveSettings();
                });

                document.getElementById('aiDifficulty').addEventListener('change', (e) => {
                    this.aiDifficulty = e.target.value;
                    this.saveSettings();
                });

                document.getElementById('soundEnabled').addEventListener('change', (e) => {
                    const enabled = e.target.value === 'true';
                    this.audioManager.setSoundEnabled(enabled);
                    this.saveSettings();
                    this.updateSoundButton();
                });
            }

            createGameBoard() {
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';
                
                // Increased cell size for bigger boxes (50% larger)
                const cellSize = Math.min(500, window.innerWidth - 80) / this.gridSize;
                const boardSize = cellSize * (this.gridSize - 1);
                
                gameGrid.style.width = boardSize + 'px';
                gameGrid.style.height = boardSize + 'px';

                this.dots = [];
                this.lines = [];
                this.boxes = [];

                // Create dots
                for (let row = 0; row < this.gridSize; row++) {
                    for (let col = 0; col < this.gridSize; col++) {
                        const dot = document.createElement('div');
                        dot.className = 'dot';
                        dot.style.left = (col * cellSize - 7) + 'px';
                        dot.style.top = (row * cellSize - 7) + 'px';
                        gameGrid.appendChild(dot);
                        this.dots.push({ element: dot, row, col });
                    }
                }

                // Create horizontal lines
                for (let row = 0; row < this.gridSize; row++) {
                    for (let col = 0; col < this.gridSize - 1; col++) {
                        const line = document.createElement('div');
                        line.className = 'line horizontal';
                        line.style.left = (col * cellSize + 7) + 'px';
                        line.style.top = (row * cellSize - 2.5) + 'px';
                        line.style.width = (cellSize - 14) + 'px';
                        line.dataset.direction = 'horizontal';
                        line.dataset.row = row;
                        line.dataset.col = col;
                        line.addEventListener('click', () => this.handleLineClick(line));
                        gameGrid.appendChild(line);
                        this.lines.push({ element: line, row, col, direction: 'horizontal', drawn: false, player: null });
                    }
                }

                // Create vertical lines
                for (let row = 0; row < this.gridSize - 1; row++) {
                    for (let col = 0; col < this.gridSize; col++) {
                        const line = document.createElement('div');
                        line.className = 'line vertical';
                        line.style.left = (col * cellSize - 2.5) + 'px';
                        line.style.top = (row * cellSize + 7) + 'px';
                        line.style.height = (cellSize - 14) + 'px';
                        line.dataset.direction = 'vertical';
                        line.dataset.row = row;
                        line.dataset.col = col;
                        line.addEventListener('click', () => this.handleLineClick(line));
                        gameGrid.appendChild(line);
                        this.lines.push({ element: line, row, col, direction: 'vertical', drawn: false, player: null });
                    }
                }

                // Create boxes (larger spacing)
                for (let row = 0; row < this.gridSize - 1; row++) {
                    for (let col = 0; col < this.gridSize - 1; col++) {
                        const box = document.createElement('div');
                        box.className = 'box';
                        box.style.left = (col * cellSize + 7) + 'px';
                        box.style.top = (row * cellSize + 7) + 'px';
                        box.style.width = (cellSize - 14) + 'px';
                        box.style.height = (cellSize - 14) + 'px';
                        gameGrid.appendChild(box);
                        this.boxes.push({ element: box, row, col, filled: false, owner: null });
                    }
                }
            }

            handleLineClick(lineElement) {
                if (!this.gameActive || this.isThinking) return;

                const row = parseInt(lineElement.dataset.row);
                const col = parseInt(lineElement.dataset.col);
                const direction = lineElement.dataset.direction;

                const line = this.lines.find(l => 
                    l.row === row && l.col === col && l.direction === direction
                );

                if (line && !line.drawn) {
                    this.drawLine(line);
                }
            }

            drawLine(line) {
                line.drawn = true;
                line.player = this.currentPlayer;
                line.element.classList.add('drawn', `player${this.currentPlayer}`);
                
                this.audioManager.playSound('line');
                
                const completedBoxes = this.checkCompletedBoxes(line);
                
                if (completedBoxes.length > 0) {
                    completedBoxes.forEach(box => {
                        this.fillBox(box, this.currentPlayer);
                    });
                    this.scores[this.currentPlayer - 1] += completedBoxes.length;
                    this.audioManager.playSound('box');
                } else {
                    this.switchPlayer();
                }

                this.updateDisplay();

                if (this.isGameComplete()) {
                    this.endGame();
                } else if (this.gameMode === 'ai' && this.currentPlayer === 2 && !this.isThinking) {
                    this.makeAIMove();
                }
            }

            checkCompletedBoxes(drawnLine) {
                const completedBoxes = [];
                
                this.boxes.forEach(box => {
                    if (!box.filled && this.isBoxComplete(box)) {
                        completedBoxes.push(box);
                    }
                });

                return completedBoxes;
            }

            isBoxComplete(box) {
                const { row, col } = box;
                
                const topLine = this.lines.find(l => 
                    l.row === row && l.col === col && l.direction === 'horizontal'
                );
                const bottomLine = this.lines.find(l => 
                    l.row === row + 1 && l.col === col && l.direction === 'horizontal'
                );
                const leftLine = this.lines.find(l => 
                    l.row === row && l.col === col && l.direction === 'vertical'
                );
                const rightLine = this.lines.find(l => 
                    l.row === row && l.col === col + 1 && l.direction === 'vertical'
                );

                return topLine?.drawn && bottomLine?.drawn && leftLine?.drawn && rightLine?.drawn;
            }

            fillBox(box, player) {
                box.filled = true;
                box.owner = player;
                box.element.classList.add('filled', `player${player}-box`);
                box.element.textContent = player === 1 ? 'P1' : (this.gameMode === 'ai' ? 'AI' : 'P2');
            }

            switchPlayer() {
                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
            }

            makeAIMove() {
                if (this.isThinking) return;
                
                this.isThinking = true;
                this.updateDisplay();

                setTimeout(() => {
                    const availableLines = this.lines.filter(line => !line.drawn);
                    if (availableLines.length === 0) {
                        this.isThinking = false;
                        return;
                    }

                    let selectedLine;

                    switch (this.aiDifficulty) {
                        case 'easy':
                            selectedLine = this.getRandomMove(availableLines);
                            break;
                        case 'medium':
                            selectedLine = this.getMediumMove(availableLines);
                            break;
                        case 'hard':
                            selectedLine = this.getHardMove(availableLines);
                            break;
                    }

                    this.isThinking = false;
                    if (selectedLine) {
                        this.drawLine(selectedLine);
                    }
                }, 800 + Math.random() * 1200);
            }

            getRandomMove(availableLines) {
                return availableLines[Math.floor(Math.random() * availableLines.length)];
            }

            getMediumMove(availableLines) {
                for (let line of availableLines) {
                    if (this.wouldCompleteBox(line)) {
                        return line;
                    }
                }

                const safeLines = availableLines.filter(line => !this.wouldGiveOpponentBox(line));
                if (safeLines.length > 0) {
                    return safeLines[Math.floor(Math.random() * safeLines.length)];
                }

                return this.getRandomMove(availableLines);
            }

            getHardMove(availableLines) {
                const completingLines = availableLines.filter(line => this.wouldCompleteBox(line));
                if (completingLines.length > 0) {
                    return completingLines[0];
                }

                const safeLines = availableLines.filter(line => !this.wouldGiveOpponentBox(line));
                if (safeLines.length > 0) {
                    const strategicLines = safeLines.filter(line => this.isStrategicPosition(line));
                    if (strategicLines.length > 0) {
                        return strategicLines[0];
                    }
                    return safeLines[0];
                }

                return availableLines[0];
            }

            wouldCompleteBox(line) {
                line.drawn = true;
                const completedBoxes = this.checkCompletedBoxes(line);
                line.drawn = false;
                return completedBoxes.length > 0;
            }

            wouldGiveOpponentBox(line) {
                line.drawn = true;
                const availableAfter = this.lines.filter(l => !l.drawn);
                let wouldGive = false;

                for (let otherLine of availableAfter) {
                    if (this.wouldCompleteBox(otherLine)) {
                        wouldGive = true;
                        break;
                    }
                }

                line.drawn = false;
                return wouldGive;
            }

            isStrategicPosition(line) {
                const totalLines = (this.gridSize - 1) * this.gridSize * 2;
                const drawnLines = this.lines.filter(l => l.drawn).length;
                
                if (drawnLines < totalLines * 0.3) {
                    const centerRow = Math.floor(this.gridSize / 2);
                    const centerCol = Math.floor(this.gridSize / 2);
                    return Math.abs(line.row - centerRow) <= 1 && Math.abs(line.col - centerCol) <= 1;
                }
                
                return true;
            }

            isGameComplete() {
                return this.boxes.every(box => box.filled);
            }

            endGame() {
                this.gameActive = false;
                const winner = this.scores[0] > this.scores[1] ? 1 : 
                              this.scores[1] > this.scores[0] ? 2 : 0;
                
                this.audioManager.playSound('win');
                
                setTimeout(() => {
                    this.showWinner(winner);
                }, 500);
            }

            showWinner(winner) {
                const winnerAnnouncement = document.getElementById('winnerAnnouncement');
                const winnerText = document.getElementById('winnerText');
                
                if (winner === 0) {
                    winnerText.innerHTML = `تعادل! 🤝<br><small>أحسنتما اللعب!</small>`;
                } else if (winner === 1) {
                    winnerText.innerHTML = `اللاعب الأول فاز! 🎉<br><small>النتيجة: ${this.scores[0]} - ${this.scores[1]}</small>`;
                } else {
                    const opponent = this.gameMode === 'ai' ? 'الذكاء الاصطناعي' : 'اللاعب الثاني';
                    winnerText.innerHTML = `${opponent} فاز! 🏆<br><small>النتيجة: ${this.scores[1]} - ${this.scores[0]}</small>`;
                }
                
                winnerAnnouncement.style.display = 'block';
            }

            updateDisplay() {
                document.getElementById('player1Score').textContent = this.scores[0];
                document.getElementById('player2Score').textContent = this.scores[1];

                const player1Card = document.getElementById('player1Card');
                const player2Card = document.getElementById('player2Card');
                
                player1Card.classList.toggle('active', this.currentPlayer === 1 && !this.isThinking);
                player2Card.classList.toggle('active', this.currentPlayer === 2 && !this.isThinking);

                const currentPlayerText = document.getElementById('currentPlayerText');
                const aiThinking = document.getElementById('aiThinking');

                if (this.isThinking) {
                    currentPlayerText.classList.add('hidden');
                    aiThinking.classList.remove('hidden');
                } else {
                    currentPlayerText.classList.remove('hidden');
                    aiThinking.classList.add('hidden');
                    
                    if (this.currentPlayer === 1) {
                        currentPlayerText.innerHTML = '<i class="fas fa-user text-blue-500"></i> دور اللاعب الأول';
                    } else {
                        const icon = this.gameMode === 'ai' ? 'fa-robot' : 'fa-user';
                        const color = this.gameMode === 'ai' ? 'text-green-500' : 'text-green-500';
                        const text = this.gameMode === 'ai' ? 'دور الذكاء الاصطناعي' : 'دور اللاعب الثاني';
                        currentPlayerText.innerHTML = `<i class="fas ${icon} ${color}"></i> ${text}`;
                    }
                }
            }

            updatePlayerLabels() {
                const player2Label = document.querySelector('#player2Card h3');
                if (this.gameMode === 'ai') {
                    player2Label.innerHTML = '<i class="fas fa-robot"></i> الذكاء الاصطناعي';
                } else {
                    player2Label.innerHTML = '<i class="fas fa-user"></i> اللاعب الثاني';
                }
            }

            startNewGame() {
                this.currentPlayer = 1;
                this.scores = [0, 0];
                this.gameActive = false;
                this.isThinking = false;
                this.initializeGame();
            }

            restartGame() {
                this.startNewGame();
            }

            saveSettings() {
                const settings = {
                    gridSize: this.gridSize,
                    gameMode: this.gameMode,
                    aiDifficulty: this.aiDifficulty,
                    soundEnabled: this.audioManager.soundEnabled
                };
                localStorage.setItem('dotsAndBoxesSettings', JSON.stringify(settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('dotsAndBoxesSettings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    this.gridSize = settings.gridSize || 4;
                    this.gameMode = settings.gameMode || 'two-player';
                    this.aiDifficulty = settings.aiDifficulty || 'medium';
                    
                    if (settings.soundEnabled !== undefined) {
                        this.audioManager.setSoundEnabled(settings.soundEnabled);
                    }

                    document.getElementById('gridSize').value = this.gridSize;
                    document.getElementById('gameMode').value = this.gameMode;
                    document.getElementById('aiDifficulty').value = this.aiDifficulty;
                    document.getElementById('soundEnabled').value = this.audioManager.soundEnabled.toString();
                }
                this.updatePlayerLabels();
                this.updateSoundButton();
            }

            updateSoundButton() {
                const soundIcon = document.getElementById('soundIcon');
                const soundText = document.getElementById('soundText');
                const soundButton = document.getElementById('soundButton');
                
                if (this.audioManager.soundEnabled) {
                    soundIcon.className = 'fas fa-volume-up';
                    soundText.textContent = 'الصوت مفعل';
                    soundButton.classList.remove('pulse');
                } else {
                    soundIcon.className = 'fas fa-volume-mute';
                    soundText.textContent = 'الصوت معطل';
                    soundButton.classList.add('pulse');
                }
            }
        }

        // Global game instance
        let game;

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            game = new DotsAndBoxesGame();
        });

        // Global functions for button handlers
        function startNewGame() {
            game.startNewGame();
        }

        function restartGame() {
            game.restartGame();
        }

        function toggleSound() {
            const newState = !game.audioManager.soundEnabled;
            game.audioManager.setSoundEnabled(newState);
            document.getElementById('soundEnabled').value = newState.toString();
            game.updateSoundButton();
            game.saveSettings();
            
            // Test sound when enabled
            if (newState) {
                setTimeout(() => {
                    game.audioManager.playSound('line');
                }, 200);
            }
        }

        function hideWinnerAnnouncement() {
            document.getElementById('winnerAnnouncement').style.display = 'none';
            game.startNewGame();
        }

        function showInstructions() {
            const instructions = `🎮 تعليمات لعبة النقاط والصناديق:

📋 القواعد الأساسية:
• اختر حجم الشبكة ووضع اللعب من الإعدادات
• اضغط على الخطوط بين النقاط لرسمها
• عندما تكمل مربعاً، ستحصل على نقطة وفرصة إضافية
• الهدف هو الحصول على أكبر عدد من المربعات

🎯 استراتيجيات الفوز:
• حاول إكمال المربعات قدر الإمكان
• تجنب إعطاء الخصم فرصة لإكمال مربعات
• راقب الخطوط المتبقية لكل مربع

🤖 وضع الذكاء الاصطناعي:
• السهل: حركات عشوائية
• المتوسط: استراتيجية أساسية
• الصعب: تفكير متقدم

🔊 الأصوات:
• أصوات مختلفة لرسم الخطوط وإكمال المربعات
• يمكن تفعيل/إلغاء الأصوات من الإعدادات

استمتع باللعب! 🎉`;

            alert(instructions);
        }

        // Theme toggle functionality
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            const themeIcon = document.getElementById('theme-icon');
            
            if (isDark) {
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('darkMode', 'true');
            } else {
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('darkMode', 'false');
            }
        }

        // Load theme preference
        document.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').className = 'fas fa-sun';
            }
        });

        // PWA Installation
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installBanner = document.createElement('div');
            installBanner.innerHTML = `
                <div style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 1000; max-width: 300px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">أضف اللعبة للشاشة الرئيسية</h4>
                    <p style="margin: 0 0 15px 0; font-size: 14px; opacity: 0.9;">العب بدون إنترنت في أي وقت!</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="installPWA()" style="flex: 1; background: white; color: #667eea; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 500;">تثبيت</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex: 1; background: transparent; color: white; border: 1px solid white; padding: 10px; border-radius: 8px; cursor: pointer;">إلغاء</button>
                    </div>
                </div>
            `;
            document.body.appendChild(installBanner);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed successfully');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,const CACHE_NAME="dots-boxes-v2";const urlsToCache=["/"];self.addEventListener("install",event=>{event.waitUntil(caches.open(CACHE_NAME).then(cache=>cache.addAll(urlsToCache)))});self.addEventListener("fetch",event=>{event.respondWith(caches.match(event.request).then(response=>{if(response){return response}return fetch(event.request)}))});')
                .then(registration => console.log('Service Worker registered successfully'))
                .catch(error => console.log('Service Worker registration failed:', error));
        }
    </script>
</body>
</html>